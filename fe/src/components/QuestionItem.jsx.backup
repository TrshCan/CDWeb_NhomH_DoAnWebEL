import React, { useState, useRef } from "react";
import { toast } from "react-hot-toast";
import EditableField from "./EditableField";
import { PlusIcon, DuplicateIcon, TrashIcon, CalendarIcon } from "../icons";
import FivePointScale from "./FivePointScale";

export default function QuestionItem({
  isActive,
  onClick,
  question,
  index,
  totalQuestions,
  moveQuestionItem,
  onDuplicate,
  onDelete,
  onTextChange,
  onAnswerSelect,
  selectedAnswer,
  conditionInfo,
  onOptionChange,
  onRemoveOption,
  onMoveOption,
  onAddOption,
  onOptionImageChange,
}) {
  // Kiá»ƒm tra image tá»« question object
  const imageValue = question?.image;
  const options = question?.options || [];

  // Width cá»§a pháº§n Ä‘Ã¡p Ã¡n: 260px khi cÃ³ áº£nh, 300px khi khÃ´ng cÃ³ áº£nh
  const answerWidth = imageValue ? "260px" : "300px";

  // State cho drag and drop
  const [draggedIndex, setDraggedIndex] = useState(null);
  const [dragOverIndex, setDragOverIndex] = useState(null);

  // State cho date input
  const [dateInputValue, setDateInputValue] = useState("");
  
  // Ref cho date picker input (áº©n)
  const datePickerRef = useRef(null);

  // State cho file upload
  const [uploadedFiles, setUploadedFiles] = useState([]);
  const [isFileDragging, setIsFileDragging] = useState(false);
  const [fileUploadError, setFileUploadError] = useState("");

  // State cho text input
  const [textInputValue, setTextInputValue] = useState("");
  const [textInputError, setTextInputError] = useState("");

  // State cho nhiá»u vÄƒn báº£n ngáº¯n (má»—i subquestion cÃ³ má»™t input)
  const [multipleTextInputs, setMultipleTextInputs] = useState({});

  // Refs Ä‘á»ƒ quáº£n lÃ½ toast vÃ  trÃ¡nh spam
  const toastTimeoutRef = useRef(null);
  const lastToastIdRef = useRef(null);

  // Chuyá»ƒn Ä‘á»•i tá»« YYYY-MM-DD sang MM/DD/YYYY
  const formatDateForDisplay = (dateString) => {
    if (!dateString) return "";
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return "";
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    const year = date.getFullYear();
    return `${month}/${day}/${year}`;
  };

  // Chuyá»ƒn Ä‘á»•i tá»« MM/DD/YYYY sang YYYY-MM-DD
  const formatDateForStorage = (dateString) => {
    if (!dateString || dateString.length !== 10) return "";
    const parts = dateString.split("/");
    if (parts.length !== 3) return "";
    const month = parts[0];
    const day = parts[1];
    const year = parts[2];

    // Validate
    const monthNum = parseInt(month, 10);
    const dayNum = parseInt(day, 10);
    const yearNum = parseInt(year, 10);

    if (monthNum < 1 || monthNum > 12) return "";
    if (dayNum < 1 || dayNum > 31) return "";
    if (yearNum < 1900 || yearNum > 2100) return "";

    // Check valid date
    const date = new Date(yearNum, monthNum - 1, dayNum);
    if (
      date.getFullYear() !== yearNum ||
      date.getMonth() !== monthNum - 1 ||
      date.getDate() !== dayNum
    ) {
      return "";
    }

    return `${year}-${month}-${day}`;
  };

  // Xá»­ lÃ½ input vá»›i mask MM/DD/YYYY - tá»± Ä‘á»™ng thÃªm dáº¥u /
  const handleDateInputChange = (e) => {
    const inputValue = e.target.value;
    
    // Láº¥y chá»‰ sá»‘ tá»« input (loáº¡i bá» táº¥t cáº£ kÃ½ tá»± khÃ´ng pháº£i sá»‘)
    let value = inputValue.replace(/[^0-9]/g, ""); // Chá»‰ láº¥y sá»‘
    
    // Giá»›i háº¡n tá»‘i Ä‘a 8 sá»‘ (MMDDYYYY)
    if (value.length > 8) {
      value = value.substring(0, 8);
    }
    
    // Format: tá»± Ä‘á»™ng thÃªm dáº¥u / sau 2 sá»‘ vÃ  sau 4 sá»‘
    let formatted = value;
    if (value.length > 2) {
      formatted = value.substring(0, 2) + "/" + value.substring(2);
    }
    if (value.length > 4) {
      formatted = value.substring(0, 2) + "/" + value.substring(2, 4) + "/" + value.substring(4);
    }

    setDateInputValue(formatted);

    // Náº¿u Ä‘á»§ 8 sá»‘ (MMDDYYYY), chuyá»ƒn Ä‘á»•i vÃ  lÆ°u
    if (value.length === 8) {
      const dateString = value.substring(0, 2) + "/" + value.substring(2, 4) + "/" + value.substring(4, 8);
      const dateForStorage = formatDateForStorage(dateString);
      if (dateForStorage) {
        onAnswerSelect?.(question.id, dateForStorage, question.type);
        // Cáº­p nháº­t date picker input
        if (datePickerRef.current) {
          datePickerRef.current.value = dateForStorage;
        }
      }
    } else {
      // Náº¿u chÆ°a Ä‘á»§, xÃ³a giÃ¡ trá»‹ Ä‘Ã£ chá»n
      onAnswerSelect?.(question.id, "", question.type);
      if (datePickerRef.current) {
        datePickerRef.current.value = "";
      }
    }
  };

  // Má»Ÿ date picker khi click vÃ o icon calendar
  const openDatePicker = (e) => {
    e.stopPropagation();
    if (datePickerRef.current) {
      if (typeof datePickerRef.current.showPicker === "function") {
        datePickerRef.current.showPicker();
      } else {
        datePickerRef.current.focus();
        datePickerRef.current.click();
      }
    }
  };

  // Xá»­ lÃ½ khi chá»n ngÃ y tá»« date picker
  const handleDatePickerChange = (e) => {
    const selectedDate = e.target.value; // Format: YYYY-MM-DD
    if (selectedDate) {
      // Chuyá»ƒn Ä‘á»•i tá»« YYYY-MM-DD sang MM/DD/YYYY Ä‘á»ƒ hiá»ƒn thá»‹
      const formatted = formatDateForDisplay(selectedDate);
      setDateInputValue(formatted);
      // LÆ°u giÃ¡ trá»‹ YYYY-MM-DD
      onAnswerSelect?.(question.id, selectedDate, question.type);
    } else {
      setDateInputValue("");
      onAnswerSelect?.(question.id, "", question.type);
    }
  };

  // Validation file upload
  const validateFile = (file, currentFileCount = 0) => {
    if (!file) {
      return { valid: false, error: "Vui lÃ²ng chá»n má»™t tá»‡p" };
    }

    // Láº¥y settings tá»« question object
    const maxFileCount = question?.maxQuestions || 1;
    const allowedFileTypes = question?.allowedFileTypes || "png, gif, doc, odt, jpg, jpeg, pdf";
    const maxFileSizeKB = question?.maxFileSizeKB || 10241;

    // Kiá»ƒm tra sá»‘ lÆ°á»£ng file
    if (currentFileCount >= maxFileCount) {
      return {
        valid: false,
        error: `ÄÃ£ Ä‘áº¡t giá»›i háº¡n sá»‘ lÆ°á»£ng tá»‡p cho phÃ©p (${maxFileCount} tá»‡p). Vui lÃ²ng xÃ³a má»™t tá»‡p trÆ°á»›c khi thÃªm má»›i.`,
      };
    }

    // Kiá»ƒm tra extension
    const allowedExtensions = allowedFileTypes.split(",").map(ext => ext.trim().toLowerCase());
    const fileExtension = file.name.split(".").pop()?.toLowerCase();
    
    if (!fileExtension || !allowedExtensions.includes(fileExtension)) {
      return {
        valid: false,
        error: `Loáº¡i tá»‡p khÃ´ng Ä‘Æ°á»£c phÃ©p. Chá»‰ cháº¥p nháº­n: ${allowedExtensions.join(", ").toUpperCase()}`,
      };
    }

    // Kiá»ƒm tra kÃ­ch thÆ°á»›c
    const maxSizeBytes = maxFileSizeKB * 1024;
    const fileSizeKB = file.size / 1024;

    if (file.size > maxSizeBytes) {
      return {
        valid: false,
        error: `KÃ­ch thÆ°á»›c tá»‡p quÃ¡ lá»›n. KÃ­ch thÆ°á»›c tá»‘i Ä‘a: ${maxFileSizeKB} KB (Hiá»‡n táº¡i: ${fileSizeKB.toFixed(2)} KB)`,
      };
    }

    return { valid: true, error: "" };
  };

  // Xá»­ lÃ½ khi chá»n file
  const handleFileSelect = (file) => {
    if (!file) return;

    // Validate file vá»›i sá»‘ lÆ°á»£ng file hiá»‡n táº¡i
    const validation = validateFile(file, uploadedFiles.length);
    if (!validation.valid) {
      setFileUploadError(validation.error);
      // Dismiss toast cÅ© náº¿u cÃ³
      if (lastToastIdRef.current) {
        toast.dismiss(lastToastIdRef.current);
      }
      const id = toast.error(validation.error, {
        style: { background: "#dc2626", color: "#fff" },
        id: "file-upload-error",
      });
      lastToastIdRef.current = id;
      return;
    }

    // Clear error náº¿u file há»£p lá»‡
    setFileUploadError("");

    const reader = new FileReader();
    reader.onload = (event) => {
      const fileData = {
        id: Date.now() + Math.random(), // Táº¡o ID duy nháº¥t cho file
        name: file.name,
        size: file.size,
        type: file.type,
        data: event.target.result, // Base64 string
      };
      
      // ThÃªm file vÃ o array
      const newFiles = [...uploadedFiles, fileData];
      setUploadedFiles(newFiles);
      
      // LÆ°u array file data vÃ o selectedAnswer
      onAnswerSelect?.(question.id, JSON.stringify(newFiles), question.type);
    };
    reader.onerror = () => {
      const errorMsg = "Lá»—i khi Ä‘á»c tá»‡p. Vui lÃ²ng thá»­ láº¡i.";
      setFileUploadError(errorMsg);
      // Dismiss toast cÅ© náº¿u cÃ³
      if (lastToastIdRef.current) {
        toast.dismiss(lastToastIdRef.current);
      }
      const id = toast.error(errorMsg, {
        style: { background: "#dc2626", color: "#fff" },
        id: "file-read-error",
      });
      lastToastIdRef.current = id;
    };
    reader.readAsDataURL(file);
  };

  // XÃ³a file
  const handleRemoveFile = (fileId) => {
    const newFiles = uploadedFiles.filter(f => f.id !== fileId);
    setUploadedFiles(newFiles);
    setFileUploadError("");
    
    // LÆ°u array má»›i vÃ o selectedAnswer
    if (newFiles.length > 0) {
      onAnswerSelect?.(question.id, JSON.stringify(newFiles), question.type);
    } else {
      onAnswerSelect?.(question.id, "", question.type);
    }
  };

  // Xá»­ lÃ½ khi click vÃ o vÃ¹ng upload
  const handleFileUploadClick = (e) => {
    e.stopPropagation();
    const input = document.createElement("input");
    input.type = "file";
    // Chá»‰ cho phÃ©p cÃ¡c loáº¡i file Ä‘Æ°á»£c phÃ©p tá»« settings
    const allowedFileTypes = question?.allowedFileTypes || "png, gif, doc, odt, jpg, jpeg, pdf";
    const acceptExtensions = allowedFileTypes.split(",").map(ext => `.${ext.trim()}`).join(",");
    input.accept = acceptExtensions;
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      handleFileSelect(file);
    };
    input.click();
  };

  // Xá»­ lÃ½ drag over
  const handleDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsFileDragging(true);
  };

  // Xá»­ lÃ½ drag leave
  const handleDragLeave = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsFileDragging(false);
  };

  // Xá»­ lÃ½ drop file
  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsFileDragging(false);
    
    const files = Array.from(e.dataTransfer?.files || []);
    // Chá»‰ xá»­ lÃ½ file Ä‘áº§u tiÃªn náº¿u drop nhiá»u file
    if (files.length > 0) {
      handleFileSelect(files[0]);
    }
  };

  // Sync dateInputValue vá»›i selectedAnswer khi selectedAnswer thay Ä‘á»•i
  React.useEffect(() => {
    if (question.type === "NgÃ y giá»") {
      const formatted = formatDateForDisplay(selectedAnswer);
      setDateInputValue(formatted || "");
      // Sync date picker input
      if (datePickerRef.current && selectedAnswer) {
        datePickerRef.current.value = selectedAnswer;
      } else if (datePickerRef.current && !selectedAnswer) {
        datePickerRef.current.value = "";
      }
    } else if (question.type === "Táº£i lÃªn tá»‡p") {
      // Sync uploadedFiles vá»›i selectedAnswer
      if (selectedAnswer) {
        try {
          const parsed = JSON.parse(selectedAnswer);
          // Kiá»ƒm tra xem lÃ  array hay object Ä‘Æ¡n
          if (Array.isArray(parsed)) {
            setUploadedFiles(parsed);
          } else {
            // Náº¿u lÃ  object Ä‘Æ¡n (format cÅ©), chuyá»ƒn thÃ nh array
            setUploadedFiles([parsed]);
          }
          setFileUploadError("");
        } catch {
          // Náº¿u khÃ´ng pháº£i JSON, reset
          setUploadedFiles([]);
          setFileUploadError("");
        }
      } else {
        setUploadedFiles([]);
        setFileUploadError("");
      }
    } else if (question.type === "VÄƒn báº£n ngáº¯n") {
      // Sync textInputValue vá»›i selectedAnswer
      setTextInputValue(selectedAnswer || "");
      setTextInputError("");
    } else if (question.type === "VÄƒn báº£n dÃ i") {
      // Sync textInputValue vá»›i selectedAnswer
      setTextInputValue(selectedAnswer || "");
      setTextInputError("");
    } else if (question.type === "Nhiá»u vÄƒn báº£n ngáº¯n") {
      // Sync multipleTextInputs vá»›i selectedAnswer
      if (selectedAnswer) {
        try {
          const parsed = JSON.parse(selectedAnswer);
          if (typeof parsed === "object" && parsed !== null) {
            setMultipleTextInputs(parsed);
          } else {
            setMultipleTextInputs({});
          }
        } catch {
          setMultipleTextInputs({});
        }
      } else {
        setMultipleTextInputs({});
      }
    }
  }, [selectedAnswer, question.type]);

  // Clear error khi maxQuestions thay Ä‘á»•i (Ä‘á»ƒ validation má»›i cÃ³ thá»ƒ cháº¡y láº¡i)
  React.useEffect(() => {
    if (question.type === "Táº£i lÃªn tá»‡p") {
      // Clear error liÃªn quan Ä‘áº¿n sá»‘ lÆ°á»£ng khi maxQuestions thay Ä‘á»•i
      // Validation sáº½ Ä‘Æ°á»£c cháº¡y láº¡i khi user thá»­ upload file má»›i
      if (fileUploadError && fileUploadError.includes("giá»›i háº¡n sá»‘ lÆ°á»£ng")) {
        setFileUploadError("");
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [question?.maxQuestions, question.type]);

  // Clear error khi numericOnly hoáº·c maxLength thay Ä‘á»•i
  React.useEffect(() => {
    if (question.type === "VÄƒn báº£n ngáº¯n" || question.type === "VÄƒn báº£n dÃ i") {
      // Clear error khi settings thay Ä‘á»•i
      setTextInputError("");
    }
  }, [question?.numericOnly, question?.maxLength, question.type]);

  // Cleanup timeout khi component unmount
  React.useEffect(() => {
    return () => {
      if (toastTimeoutRef.current) {
        clearTimeout(toastTimeoutRef.current);
      }
    };
  }, []);

  // Helper function Ä‘á»ƒ hiá»ƒn thá»‹ toast vá»›i debounce
  const showToastError = (errorMsg, toastId = "text-error") => {
    // Clear timeout cÅ© náº¿u cÃ³
    if (toastTimeoutRef.current) {
      clearTimeout(toastTimeoutRef.current);
    }

    // Dismiss toast cÅ© cÃ¹ng loáº¡i náº¿u cÃ³
    if (lastToastIdRef.current) {
      toast.dismiss(lastToastIdRef.current);
    }

    // Hiá»ƒn thá»‹ toast má»›i sau 300ms debounce
    toastTimeoutRef.current = setTimeout(() => {
      const id = toast.error(errorMsg, {
        style: { background: "#dc2626", color: "#fff" },
        id: toastId, // Sá»­ dá»¥ng cÃ¹ng ID Ä‘á»ƒ replace toast cÅ©
      });
      lastToastIdRef.current = id;
    }, 300);
  };

  // Xá»­ lÃ½ khi nháº­p text cho nhiá»u vÄƒn báº£n ngáº¯n
  const handleMultipleTextInputChange = (optionId, value) => {
    const maxLength = 256;
    
    // Kiá»ƒm tra Ä‘á»™ dÃ i
    if (value.length > maxLength) {
      return; // KhÃ´ng cho phÃ©p nháº­p quÃ¡ 256 kÃ½ tá»±
    }

    // Cáº­p nháº­t state
    const newInputs = { ...multipleTextInputs, [optionId]: value };
    setMultipleTextInputs(newInputs);
    
    // LÆ°u vÃ o selectedAnswer dÆ°á»›i dáº¡ng JSON
    onAnswerSelect?.(question.id, JSON.stringify(newInputs), question.type);
  };

  // Xá»­ lÃ½ khi nháº­p text
  const handleTextInputChange = (e) => {
    const value = e.target.value;
    const isNumericOnly = question?.numericOnly === true;
    const maxLength = question?.maxLength || (isLongTextType() ? 2500 : 256);

    // Kiá»ƒm tra Ä‘á»™ dÃ i trÆ°á»›c - khÃ´ng cho phÃ©p nháº­p quÃ¡ maxLength
    if (value.length > maxLength) {
      // KhÃ´ng cho phÃ©p nháº­p quÃ¡ 256 kÃ½ tá»±
      const errorMsg = `VÆ°á»£t quÃ¡ sá»‘ kÃ½ tá»± cho phÃ©p (${maxLength} kÃ½ tá»±)`;
      setTextInputError(errorMsg);
      showToastError(errorMsg, "max-length-error");
      // Giá»¯ nguyÃªn giÃ¡ trá»‹ cÅ© (khÃ´ng cáº­p nháº­t)
      return;
    }

    // Kiá»ƒm tra náº¿u chá»‰ cho phÃ©p sá»‘
    if (isNumericOnly) {
      // Chá»‰ cho phÃ©p sá»‘ - chá»‰ láº¥y cÃ¡c kÃ½ tá»± sá»‘
      const numericValue = value.replace(/[^0-9]/g, "");
      if (value !== numericValue) {
        // Náº¿u cÃ³ kÃ½ tá»± khÃ´ng pháº£i sá»‘, hiá»ƒn thá»‹ lá»—i nhÆ°ng váº«n cáº­p nháº­t vá»›i giÃ¡ trá»‹ Ä‘Ã£ lá»c
        const errorMsg = "Chá»‰ Ä‘Æ°á»£c phÃ©p nháº­p sá»‘";
        setTextInputError(errorMsg);
        showToastError(errorMsg, "numeric-only-error");
        setTextInputValue(numericValue);
        onAnswerSelect?.(question.id, numericValue, question.type);
        return;
      }
    }

    // Clear error náº¿u há»£p lá»‡
    setTextInputError("");
    setTextInputValue(value);
    onAnswerSelect?.(question.id, value, question.type);
  };

  // âœ… Helper: kiá»ƒm tra xem option cÃ³ Ä‘ang Ä‘Æ°á»£c chá»n khÃ´ng
  const isOptionChecked = (selectedAnswer, optionId) => {
    if (Array.isArray(selectedAnswer)) {
      return selectedAnswer.map(String).includes(String(optionId));
    }
    return String(selectedAnswer) === String(optionId);
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i radio button khÃ´ng
  const isRadioType = () => {
    return (
      question.type === "Danh sÃ¡ch (nÃºt chá»n)" ||
      question.type === "Danh sÃ¡ch cÃ³ nháº­n xÃ©t (Radio)" ||
      question.type === "Chá»n hÃ¬nh áº£nh tá»« danh sÃ¡ch (Radio)"
    );
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i image option khÃ´ng
  const isImageOptionType = () => {
    return (
      question.type === "Chá»n hÃ¬nh áº£nh tá»« danh sÃ¡ch (Radio)" ||
      question.type === "Chá»n nhiá»u hÃ¬nh áº£nh"
    );
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i 5 Ä‘iá»ƒm khÃ´ng
  const isFivePointScale = () => {
    return question.type === "Lá»±a chá»n 5 Ä‘iá»ƒm";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i Giá»›i tÃ­nh khÃ´ng
  const isGenderType = () => {
    return question.type === "Giá»›i tÃ­nh";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i CÃ³/KhÃ´ng khÃ´ng
  const isYesNoType = () => {
    return question.type === "CÃ³/KhÃ´ng";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i NgÃ y giá» khÃ´ng
  const isDateTimeType = () => {
    return question.type === "NgÃ y giá»";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i Táº£i lÃªn tá»‡p khÃ´ng
  const isFileUploadType = () => {
    return question.type === "Táº£i lÃªn tá»‡p";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i VÄƒn báº£n ngáº¯n khÃ´ng
  const isShortTextType = () => {
    return question.type === "VÄƒn báº£n ngáº¯n";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i VÄƒn báº£n dÃ i khÃ´ng
  const isLongTextType = () => {
    return question.type === "VÄƒn báº£n dÃ i";
  };

  // âœ… Helper: kiá»ƒm tra xem cÃ³ pháº£i loáº¡i Nhiá»u vÄƒn báº£n ngáº¯n khÃ´ng
  const isMultipleShortTextType = () => {
    return question.type === "Nhiá»u vÄƒn báº£n ngáº¯n";
  };

  // âœ… Handler: Upload áº£nh cho option
  const handleOptionImageUpload = (optionId) => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          onOptionImageChange?.(question.id, optionId, event.target.result);
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  };

  return (
    <div
      className="relative"
      style={{
        overflow: "visible",
        position: "relative",
        width: "100%",
        marginRight: "45px", // Táº¡o khÃ´ng gian cho nÃºt di chuyá»ƒn
      }}
    >
      {/* Dáº¥u * cho cÃ¢u há»i báº¯t buá»™c (chá»‰ hiá»‡n khi Báº­t/true) */}
      {question?.required === true && (
        <span className="absolute top-2 right-4 z-50 text-red-500 text-[30px] font-bold select-none pointer-events-none">
          *
        </span>
      )}

      {/* ======================= NÃšT MOVE LÃŠN/XUá»NG - Äáº¶T BÃŠN NGOÃ€I ======================= */}
      {isActive && (
        <div
          className="absolute flex flex-col items-center space-y-1"
          style={{
            top: "50%",
            right: "-37px", // 22px icon + 15px khoáº£ng cÃ¡ch
            transform: "translateY(-50%)",
            zIndex: 1000,
            pointerEvents: "auto",
            position: "absolute",
            willChange: "transform", // Tá»‘i Æ°u rendering
          }}
        >
          {/* Up */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              moveQuestionItem(index, "up");
            }}
            disabled={index === 0}
            className={`rounded p-0.5 transition-colors duration-150 shadow ${
              index === 0
                ? "bg-gray-400 opacity-50 cursor-not-allowed"
                : "bg-gray-500 hover:bg-gray-600 active:bg-gray-700"
            }`}
            aria-label="Move up"
            style={{
              width: "22px",
              height: "22px",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
            }}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              stroke="white"
              strokeWidth="4.5"
              strokeLinecap="square"
              strokeLinejoin="miter"
              fill="none"
            >
              <polyline points="6 14 12 8 18 14" />
            </svg>
          </button>

          {/* Down */}
          <button
            onClick={(e) => {
              e.stopPropagation();
              moveQuestionItem(index, "down");
            }}
            disabled={index === totalQuestions - 1}
            className={`rounded p-0.5 transition-colors duration-150 shadow ${
              index === totalQuestions - 1
                ? "bg-gray-400 opacity-50 cursor-not-allowed"
                : "bg-gray-500 hover:bg-gray-600 active:bg-gray-700"
            }`}
            aria-label="Move down"
            style={{
              width: "22px",
              height: "22px",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
            }}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              stroke="white"
              strokeWidth="4.5"
              strokeLinecap="square"
              strokeLinejoin="miter"
              fill="none"
            >
              <polyline points="6 10 12 16 18 10" />
            </svg>
          </button>
        </div>
      )}

      <div
        onClick={(e) => {
          e.stopPropagation();
          onClick?.();
        }}
        className={[
          "peer cursor-pointer rounded-sm transition-shadow duration-150 relative",
          "hover:ring-2 hover:ring-inset hover:ring-violet-600",
          "focus-within:ring-2 focus-within:ring-inset focus-within:ring-violet-600",
          isActive
            ? "ring-2 ring-inset ring-violet-600 z-10 bg-white"
            : "z-0 bg-white",
        ].join(" ")}
        style={{ minHeight: imageValue ? "350px" : "250px" }}
      >
        {/* ThÃ´ng bÃ¡o Ä‘iá»u kiá»‡n hiá»ƒn thá»‹ */}
        {conditionInfo && conditionInfo.length > 0 && (
          <div className="absolute top-1 right-[50px] z-20">
            <div className="text-xs text-red-500 italic">
              {conditionInfo.map((msg, idx) => (
                <div key={idx} className="leading-tight">
                  {msg}
                </div>
              ))}
            </div>
          </div>
        )}
        {imageValue ? (
          /* ======================= Bá» Cá»¤C 2 Cá»˜T (CÃ“ áº¢NH) ======================= */
          <div
            className="flex justify-between gap-[16px] px-[28px] py-[38px] pb-[38px]"
            style={{ alignItems: "flex-start" }}
          >
            {/* Cá»™t trÃ¡i - áº¢nh (50%) */}
            <div
              className="flex-1"
              style={{
                position: "relative",
              }}
            >
              <img
                key={imageValue}
                src={imageValue}
                alt="Question"
                style={{
                  width: "100%",
                  height: "auto",
                  objectFit: "contain",
                  display: "block",
                }}
                onLoad={() => {
                  console.log(
                    "âœ… Image loaded successfully for question:",
                    question.id
                  );
                }}
                onError={(e) => {
                  console.error(
                    "âŒ Image error for question:",
                    question.id,
                    "Image URL:",
                    imageValue?.substring(0, 100)
                  );
                  e.target.style.display = "none";
                }}
              />
            </div>

            {/* Cá»™t pháº£i - Ná»™i dung cÃ¢u há»i (50%) */}
            <div className="flex-1 flex flex-col">
              <div className="flex items-baseline">
                <span className="text-violet-600 font-medium mr-2 whitespace-nowrap">
                  {index + 1} â†’
                </span>
                <div className="w-full">
                  <EditableField
                    placeholder="CÃ¢u há»i cá»§a báº¡n á»Ÿ Ä‘Ã¢y"
                    initialValue={question.text}
                    inputClassName="text-gray-800 font-thin text-[25px]"
                    onChange={(value) => onTextChange?.(question.id, value)}
                  />
                  <EditableField
                    placeholder="MÃ´ táº£ trá»£ giÃºp tuá»³ chá»n"
                    initialValue={question.helpText}
                    inputClassName="text-sm text-gray-800 mt-1 mb-4 italic font-medium"
                  />
                </div>
              </div>

              {/* Render 5 Ä‘iá»ƒm náº¿u lÃ  loáº¡i Lá»±a chá»n 5 Ä‘iá»ƒm */}
              {isFivePointScale() ? (
                <FivePointScale
                  questionId={question.id}
                  selectedAnswer={selectedAnswer}
                  onAnswerSelect={onAnswerSelect}
                  isActive={isActive}
                  hasImage={true}
                />
              ) : isGenderType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i Giá»›i tÃ­nh */
                <div className="ml-[28px] flex gap-4 flex-wrap">
                  {options.map((option) => {
                    const isSelected = isOptionChecked(
                      selectedAnswer,
                      option.id
                    );
                    const isNoAnswer = option.text === "KhÃ´ng cÃ³ cÃ¢u tráº£ lá»i";

                    return (
                      <button
                        key={option.id}
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          onAnswerSelect?.(
                            question.id,
                            option.id,
                            question.type
                          );
                        }}
                        className="gender-button relative group"
                        style={{
                          width: isNoAnswer ? "173px" : "90px",
                          height: "75px",
                        }}
                      >
                        <div
                          className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-all
                        ${
                          isSelected
                            ? "bg-[#10B981] border-[#10B981] text-white"
                            : isNoAnswer
                            ? "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                            : "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                        }
                      `}
                        >
                          {option.text === "Ná»¯" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M11 15.934A7.501 7.501 0 0 1 12 1a7.5 7.5 0 0 1 1 14.934V18h5v2h-5v4h-2v-4H6v-2h5v-2.066zM12 14a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                            </svg>
                          )}
                          {option.text === "Nam" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M15.05 8.537L18.585 5H14V3h8v8h-2V6.414l-3.537 3.537a7.5 7.5 0 1 1-1.414-1.414zM10.5 20a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                            </svg>
                          )}
                          {isNoAnswer && (
                            <svg
                              role="img"
                              xmlns="http://www.w3.org/2000/svg"
                              width="32px"
                              height="32px"
                              viewBox="0 0 24 24"
                              aria-labelledby="circleIconTitle"
                              stroke={isSelected ? "#ffffff" : "#4b5563"}
                              strokeWidth="1.5"
                              strokeLinecap="square"
                              strokeLinejoin="miter"
                              fill="none"
                              color={isSelected ? "#ffffff" : "#4b5563"}
                              className="mb-1 transition-colors"
                            >
                              <title id="circleIconTitle">Circle</title>
                              <circle cx="12" cy="12" r="8" />
                            </svg>
                          )}
                          <span
                            className="text-sm font-medium transition-colors"
                            style={{
                              color: isSelected ? "#ffffff" : "#4b5563",
                              width: isNoAnswer ? "145px" : "auto",
                              height: isNoAnswer ? "24px" : "auto",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              textAlign: "center",
                            }}
                          >
                            {option.text}
                          </span>
                        </div>
                        {/* Overlay khi hover Ä‘á»ƒ Ä‘á»•i mÃ u icon vÃ  chá»¯ */}
                        <div
                          className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-opacity pointer-events-none
                        bg-[#10B981] border-[#10B981] text-white
                        ${
                          isSelected
                            ? "opacity-100"
                            : "opacity-0 group-hover:opacity-100"
                        }
                      `}
                        >
                          {option.text === "Ná»¯" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M11 15.934A7.501 7.501 0 0 1 12 1a7.5 7.5 0 0 1 1 14.934V18h5v2h-5v4h-2v-4H6v-2h5v-2.066zM12 14a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                            </svg>
                          )}
                          {option.text === "Nam" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M15.05 8.537L18.585 5H14V3h8v8h-2V6.414l-3.537 3.537a7.5 7.5 0 1 1-1.414-1.414zM10.5 20a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                            </svg>
                          )}
                          {isNoAnswer && (
                            <svg
                              role="img"
                              xmlns="http://www.w3.org/2000/svg"
                              width="32px"
                              height="32px"
                              viewBox="0 0 24 24"
                              aria-labelledby="circleIconTitle"
                              stroke="#ffffff"
                              strokeWidth="1.5"
                              strokeLinecap="square"
                              strokeLinejoin="miter"
                              fill="none"
                              color="#ffffff"
                              className="mb-1"
                            >
                              <title id="circleIconTitle">Circle</title>
                              <circle cx="12" cy="12" r="8" />
                            </svg>
                          )}
                          <span
                            className="text-sm font-medium text-white"
                            style={{
                              width: isNoAnswer ? "145px" : "auto",
                              height: isNoAnswer ? "24px" : "auto",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              textAlign: "center",
                            }}
                          >
                            {option.text}
                          </span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              ) : isYesNoType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i CÃ³/KhÃ´ng */
                <div className="ml-[28px] flex gap-4 flex-wrap">
                  {options.map((option) => {
                    const isSelected = isOptionChecked(
                      selectedAnswer,
                      option.id
                    );
                    const isNoAnswer = option.text === "KhÃ´ng cÃ³ cÃ¢u tráº£ lá»i";

                    return (
                      <button
                        key={option.id}
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          onAnswerSelect?.(
                            question.id,
                            option.id,
                            question.type
                          );
                        }}
                        className="gender-button relative group"
                        style={{
                          width: isNoAnswer ? "173px" : "90px",
                          height: "75px",
                        }}
                      >
                        <div
                          className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-all
                        ${
                          isSelected
                            ? "bg-[#10B981] border-[#10B981] text-white"
                            : isNoAnswer
                            ? "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                            : "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                        }
                      `}
                        >
                          {option.text === "CÃ³" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"></path>
                            </svg>
                          )}
                          {option.text === "KhÃ´ng" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"></path>
                            </svg>
                          )}
                          {isNoAnswer && (
                            <svg
                              role="img"
                              xmlns="http://www.w3.org/2000/svg"
                              width="32px"
                              height="32px"
                              viewBox="0 0 24 24"
                              aria-labelledby="circleIconTitle"
                              stroke={isSelected ? "#ffffff" : "#4b5563"}
                              strokeWidth="1.5"
                              strokeLinecap="square"
                              strokeLinejoin="miter"
                              fill="none"
                              color={isSelected ? "#ffffff" : "#4b5563"}
                              className="mb-1 transition-colors"
                            >
                              <title id="circleIconTitle">Circle</title>
                              <circle cx="12" cy="12" r="8" />
                            </svg>
                          )}
                          <span
                            className="text-sm font-medium transition-colors"
                            style={{
                              color: isSelected ? "#ffffff" : "#4b5563",
                              width: isNoAnswer ? "145px" : "auto",
                              height: isNoAnswer ? "24px" : "auto",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              textAlign: "center",
                            }}
                          >
                            {option.text}
                          </span>
                        </div>
                        {/* Overlay khi hover Ä‘á»ƒ Ä‘á»•i mÃ u icon vÃ  chá»¯ */}
                        <div
                          className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-opacity pointer-events-none
                        bg-[#10B981] border-[#10B981] text-white
                        ${
                          isSelected
                            ? "opacity-100"
                            : "opacity-0 group-hover:opacity-100"
                        }
                      `}
                        >
                          {option.text === "CÃ³" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"></path>
                            </svg>
                          )}
                          {option.text === "KhÃ´ng" && (
                            <svg
                              width="32"
                              height="32"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"></path>
                            </svg>
                          )}
                          {isNoAnswer && (
                            <svg
                              role="img"
                              xmlns="http://www.w3.org/2000/svg"
                              width="32px"
                              height="32px"
                              viewBox="0 0 24 24"
                              aria-labelledby="circleIconTitle"
                              stroke="#ffffff"
                              strokeWidth="1.5"
                              strokeLinecap="square"
                              strokeLinejoin="miter"
                              fill="none"
                              color="#ffffff"
                              className="mb-1"
                            >
                              <title id="circleIconTitle">Circle</title>
                              <circle cx="12" cy="12" r="8" />
                            </svg>
                          )}
                          <span
                            className="text-sm font-medium text-white"
                            style={{
                              width: isNoAnswer ? "145px" : "auto",
                              height: isNoAnswer ? "24px" : "auto",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              textAlign: "center",
                            }}
                          >
                            {option.text}
                          </span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              ) : isDateTimeType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i NgÃ y giá» */
                <div className="ml-[28px]">
                  <div
                    className="relative"
                    style={{ width: "326px", height: "43px" }}
                  >
                    {/* Input áº©n cho date picker */}
                    <input
                      ref={datePickerRef}
                      type="date"
                      style={{
                        position: "absolute",
                        opacity: 0,
                        pointerEvents: "none",
                        width: 0,
                        height: 0,
                        overflow: "hidden",
                      }}
                      onChange={handleDatePickerChange}
                      onClick={(e) => e.stopPropagation()}
                    />
                    <input
                      type="text"
                      className="border-[3px] border-gray-400 rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none uppercase"
                      style={{
                        width: "326px",
                        height: "43px",
                        paddingRight: "40px",
                        fontSize: "14px",
                        letterSpacing: "0.5px",
                      }}
                      placeholder="MM/DD/YYYY"
                      value={dateInputValue}
                      onChange={handleDateInputChange}
                      onClick={(e) => e.stopPropagation()}
                      maxLength={10}
                    />
                    <button
                      type="button"
                      aria-label="Open date picker"
                      className="absolute right-2 top-1/2 -translate-y-1/2 rounded hover:bg-gray-100 transition-colors pointer-events-auto"
                      onClick={openDatePicker}
                      style={{
                        width: "24px",
                        height: "24px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                      }}
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        className="text-gray-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        strokeWidth={2}
                        style={{ width: "24px", height: "24px" }}
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              ) : isFileUploadType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i Táº£i lÃªn tá»‡p */
                <div className="ml-[28px]">
                  <div
                    className={`border-2 border-dashed rounded-md transition-colors cursor-pointer ${
                      isFileDragging
                        ? "border-violet-500 bg-violet-50"
                        : "border-gray-400 bg-gray-50 hover:bg-gray-100"
                    }`}
                    style={{
                      width: "100%",
                      minHeight: "200px",
                      padding: "40px",
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                    }}
                    onClick={handleFileUploadClick}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                  >
                    {uploadedFiles.length > 0 ? (
                      <div className="flex flex-col items-center space-y-3 w-full">
                        {uploadedFiles.map((file) => (
                          <div
                            key={file.id}
                            className="flex items-center space-x-3 bg-white rounded-md p-4 border-2 border-gray-300 w-full max-w-md"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="32"
                              height="32"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              strokeWidth="2"
                              className="text-gray-600"
                            >
                              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                              <polyline points="14 2 14 8 20 8" />
                              <line x1="16" y1="13" x2="8" y2="13" />
                              <line x1="16" y1="17" x2="8" y2="17" />
                              <polyline points="10 9 9 9 8 9" />
                            </svg>
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium text-gray-800 truncate">
                                {file.name}
                              </p>
                              <p className="text-xs text-gray-500">
                                {(file.size / 1024).toFixed(2)} KB
                              </p>
                            </div>
                            {(isActive || !isActive) && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleRemoveFile(file.id);
                                }}
                                className="text-red-500 hover:text-red-700 transition-colors"
                                title="XÃ³a file"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="20"
                                  height="20"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                  strokeWidth="2"
                                >
                                  <line x1="18" y1="6" x2="6" y2="18" />
                                  <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                              </button>
                            )}
                          </div>
                        ))}
                        {!isActive && uploadedFiles.length < (question?.maxQuestions || 1) && (
                          <button
                            onClick={handleFileUploadClick}
                            className="text-sm text-violet-600 hover:text-violet-800 font-medium"
                          >
                            ThÃªm tá»‡p khÃ¡c
                          </button>
                        )}
                        {uploadedFiles.length >= (question?.maxQuestions || 1) && (
                          <p className="text-xs text-gray-500 italic">
                            ÄÃ£ Ä‘áº¡t giá»›i háº¡n ({question?.maxQuestions || 1} tá»‡p)
                          </p>
                        )}
                      </div>
                    ) : (
                      <div className="flex flex-col items-center space-y-3">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="48"
                          height="48"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          strokeWidth="2"
                          className="text-gray-400"
                        >
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                          <polyline points="17 8 12 3 7 8" />
                          <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        <p className="text-sm text-gray-600 font-medium">
                          Chá»n tá»‡p hoáº·c kÃ©o hÃ¬nh áº£nh vÃ o Ä‘Ã¢y
                        </p>
                        <p className="text-xs text-gray-500 mt-1">
                          Äá»‹nh dáº¡ng: {(question?.allowedFileTypes || "png, gif, doc, odt, jpg, jpeg, pdf").toUpperCase()} â€¢ KÃ­ch thÆ°á»›c tá»‘i Ä‘a: {question?.maxFileSizeKB || 10241} KB â€¢ Sá»‘ lÆ°á»£ng tá»‘i Ä‘a: {question?.maxQuestions || 1} tá»‡p
                        </p>
                      </div>
                    )}
                    {fileUploadError && (
                      <div className="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-md p-2 w-full max-w-md">
                        {fileUploadError}
                      </div>
                    )}
                  </div>
                </div>
              ) : isShortTextType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i VÄƒn báº£n ngáº¯n */
                <div className="ml-[28px]">
                  <input
                    type="text"
                    className={`border-[3px] rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none ${
                      textInputError
                        ? "border-red-500"
                        : "border-gray-400 focus:border-violet-500"
                    }`}
                    style={{
                      width: "651px",
                      height: "36px",
                      fontSize: "14px",
                    }}
                    placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                    value={textInputValue}
                    onChange={handleTextInputChange}
                    onClick={(e) => e.stopPropagation()}
                    maxLength={question?.maxLength || 256}
                  />
                  {textInputError && (
                    <div className="mt-2 text-sm text-red-600">
                      {textInputError}
                    </div>
                  )}
                </div>
              ) : isLongTextType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i VÄƒn báº£n dÃ i */
                <div className="ml-[28px]">
                  <textarea
                    className={`border-[3px] rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none ${
                      textInputError
                        ? "border-red-500"
                        : "border-gray-400 focus:border-violet-500"
                    }`}
                    style={{
                      width: "651px",
                      minHeight: "100px",
                      fontSize: "14px",
                      resize: "vertical",
                    }}
                    placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                    value={textInputValue}
                    onChange={handleTextInputChange}
                    onClick={(e) => e.stopPropagation()}
                    maxLength={question?.maxLength || 2500}
                  />
                  {textInputError && (
                    <div className="mt-2 text-sm text-red-600">
                      {textInputError}
                    </div>
                  )}
                </div>
              ) : isMultipleShortTextType() ? (
                /* UI Ä‘áº·c biá»‡t cho loáº¡i Nhiá»u vÄƒn báº£n ngáº¯n */
                options.length > 0 && (
                  <div className="ml-[28px] space-y-4">
                    {options.map((option, optionIndex) => {
                      const isDragging = draggedIndex === optionIndex;
                      const isDragOver = dragOverIndex === optionIndex;

                      const handleDragStart = (e) => {
                        setDraggedIndex(optionIndex);
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData(
                          "text/plain",
                          optionIndex.toString()
                        );
                      };

                      const handleDragOver = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.dataTransfer.dropEffect = "move";
                        if (dragOverIndex !== optionIndex) {
                          setDragOverIndex(optionIndex);
                        }
                      };

                      const handleDragLeave = (e) => {
                        e.preventDefault();
                        const rect = e.currentTarget.getBoundingClientRect();
                        const x = e.clientX;
                        const y = e.clientY;
                        if (
                          x < rect.left ||
                          x > rect.right ||
                          y < rect.top ||
                          y > rect.bottom
                        ) {
                          setDragOverIndex(null);
                        }
                      };

                      const handleDrop = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (
                          draggedIndex !== null &&
                          draggedIndex !== optionIndex &&
                          onMoveOption
                        ) {
                          onMoveOption(question.id, draggedIndex, optionIndex);
                        }
                        setDraggedIndex(null);
                        setDragOverIndex(null);
                      };

                      const handleDragEnd = () => {
                        setDraggedIndex(null);
                        setDragOverIndex(null);
                      };

                      return (
                        <div
                          key={option.id}
                          className={isActive ? "flex items-center group" : "flex flex-col group"}
                          style={{
                            gap: "8px",
                            minHeight: "40px",
                            opacity: isDragging ? 1 : 1,
                            transition: "all 0.2s",
                            backgroundColor: isDragging
                              ? "#ffffff"
                              : isDragOver
                              ? "#f3f4f6"
                              : "transparent",
                            border: isDragging
                              ? "2px solid #7c3aed"
                              : "2px solid transparent",
                            borderRadius: isDragging ? "6px" : "0px",
                            padding: isDragging ? "4px" : "0px",
                          }}
                          onDragOver={handleDragOver}
                          onDragLeave={handleDragLeave}
                          onDrop={handleDrop}
                        >
                          {/* Khi active: hiá»ƒn thá»‹ icon X vÃ  icon grid */}
                          {isActive ? (
                            <>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  onRemoveOption?.(question.id, option.id);
                                }}
                                className="flex-shrink-0 hover:bg-red-100 rounded-full transition-colors"
                                title="XÃ³a Ä‘Ã¡p Ã¡n"
                                style={{
                                  width: "13px",
                                  height: "13px",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  backgroundColor: "#ef4444",
                                  border: "none",
                                  padding: "0",
                                }}
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="8"
                                  height="8"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="white"
                                  strokeWidth="3"
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                >
                                  <line x1="18" y1="6" x2="6" y2="18" />
                                  <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                              </button>
                              <div
                                draggable={isActive}
                                onDragStart={handleDragStart}
                                onDragEnd={handleDragEnd}
                                className="cursor-move flex-shrink-0 hover:bg-gray-200 rounded transition-colors"
                                title="Nháº¥n giá»¯ vÃ  kÃ©o Ä‘á»ƒ di chuyá»ƒn Ä‘Ã¡p Ã¡n"
                                style={{
                                  width: "18px",
                                  height: "14px",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  padding: "2px",
                                  userSelect: "none",
                                }}
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="18"
                                  height="10"
                                  viewBox="0 0 18 10"
                                  fill="currentColor"
                                  className="text-gray-600"
                                >
                                  <circle cx="2" cy="2" r="1.5" />
                                  <circle cx="9" cy="2" r="1.5" />
                                  <circle cx="16" cy="2" r="1.5" />
                                  <circle cx="2" cy="8" r="1.5" />
                                  <circle cx="9" cy="8" r="1.5" />
                                  <circle cx="16" cy="8" r="1.5" />
                                </svg>
                              </div>
                            </>
                          ) : null}
                          {/* Text cá»§a subquestion */}
                          <div className="flex items-center" style={{ width: "290px", wordWrap: "break-word" }}>
                            <EditableField
                              placeholder="Subquestion"
                              initialValue={option.text}
                              inputClassName="text-gray-800 font-medium"
                              isTextarea={true}
                              onChange={(value) =>
                                onOptionChange?.(question.id, option.id, value)
                              }
                            />
                          </div>
                          {/* Input text bÃªn cáº¡nh (khi khÃ´ng active) */}
                          {!isActive && (
                            <input
                              type="text"
                              className="border-[3px] border-gray-400 rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none focus:border-violet-500"
                              style={{
                                width: imageValue ? "174px" : "300px",
                                height: "40px",
                                fontSize: "14px",
                              }}
                              placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                              value={multipleTextInputs[option.id] || ""}
                              onChange={(e) => {
                                e.stopPropagation();
                                handleMultipleTextInputChange(option.id, e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              maxLength={256}
                            />
                          )}
                        </div>
                      );
                    })}
                    {/* NÃºt thÃªm subquestion khi active */}
                    {isActive && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onAddOption?.(question.id);
                        }}
                        className="text-violet-600 hover:text-violet-800 font-medium text-sm flex items-center"
                      >
                        <PlusIcon className="w-4 h-4 mr-1" />
                        ThÃªm cÃ¢u há»i phá»¥
                      </button>
                    )}
                  </div>
                )
              ) : (
                /* Danh sÃ¡ch Ä‘Ã¡p Ã¡n */
                options.length > 0 && (
                  <div className="ml-[28px] space-y-4">
                    {options.map((option, optionIndex) => {
                      const isDragging = draggedIndex === optionIndex;
                      const isDragOver = dragOverIndex === optionIndex;

                      const handleDragStart = (e) => {
                        setDraggedIndex(optionIndex);
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData(
                          "text/plain",
                          optionIndex.toString()
                        );

                        // Táº¡o custom drag image tá»« cáº£ dÃ²ng Ä‘Ã¡p Ã¡n
                        const rowElement = e.currentTarget.closest(
                          ".flex.items-center.group"
                        );
                        if (rowElement) {
                          const dragImage = rowElement.cloneNode(true);
                          dragImage.style.position = "absolute";
                          dragImage.style.top = "-9999px";
                          dragImage.style.left = "-9999px";
                          dragImage.style.width = rowElement.offsetWidth + "px";
                          dragImage.style.backgroundColor = "#ffffff";
                          dragImage.style.border = "3px solid #7c3aed";
                          dragImage.style.borderRadius = "8px";
                          dragImage.style.padding = "10px";
                          dragImage.style.boxShadow =
                            "0 8px 24px rgba(124, 58, 237, 0.3), 0 4px 8px rgba(0,0,0,0.1)";
                          dragImage.style.transform = "scale(1.02)";
                          dragImage.style.fontWeight = "600";
                          document.body.appendChild(dragImage);
                          e.dataTransfer.setDragImage(dragImage, 30, 20);
                          setTimeout(
                            () => document.body.removeChild(dragImage),
                            0
                          );
                        }
                      };

                      const handleDragOver = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.dataTransfer.dropEffect = "move";
                        if (dragOverIndex !== optionIndex) {
                          setDragOverIndex(optionIndex);
                        }
                      };

                      const handleDragLeave = (e) => {
                        e.preventDefault();
                        // Chá»‰ xÃ³a dragOverIndex náº¿u khÃ´ng cÃ²n á»Ÿ trong container
                        const rect = e.currentTarget.getBoundingClientRect();
                        const x = e.clientX;
                        const y = e.clientY;
                        if (
                          x < rect.left ||
                          x > rect.right ||
                          y < rect.top ||
                          y > rect.bottom
                        ) {
                          setDragOverIndex(null);
                        }
                      };

                      const handleDrop = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        if (
                          draggedIndex !== null &&
                          draggedIndex !== optionIndex &&
                          onMoveOption
                        ) {
                          onMoveOption(question.id, draggedIndex, optionIndex);
                        }

                        setDraggedIndex(null);
                        setDragOverIndex(null);
                      };

                      const handleDragEnd = () => {
                        setDraggedIndex(null);
                        setDragOverIndex(null);
                      };

                      return (
                        <div
                          key={option.id}
                          className={
                            isImageOptionType()
                              ? "flex items-start group"
                              : "inline-flex items-center group"
                          }
                          style={{
                            gap: "8px",
                            minHeight: "40px",
                            opacity: isDragging ? 1 : 1,
                            transition: "all 0.2s",
                            backgroundColor: isDragging
                              ? "#ffffff"
                              : isDragOver
                              ? "#f3f4f6"
                              : "transparent",
                            border: isDragging
                              ? "2px solid #7c3aed"
                              : "2px solid transparent",
                            borderRadius: isDragging ? "6px" : "0px",
                            padding: isDragging ? "4px" : "0px",
                          }}
                          onDragOver={handleDragOver}
                          onDragLeave={handleDragLeave}
                          onDrop={handleDrop}
                        >
                          {/* Khi active: hiá»ƒn thá»‹ icon X (hÃ¬nh trÃ²n 13x13) vÃ  icon grid (14x14) */}
                          {isActive ? (
                            <>
                              {/* Icon X Ä‘á»ƒ xÃ³a - hÃ¬nh trÃ²n 13x13 */}
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  onRemoveOption?.(question.id, option.id);
                                }}
                                className="flex-shrink-0 hover:bg-red-100 rounded-full transition-colors"
                                title="XÃ³a Ä‘Ã¡p Ã¡n"
                                style={{
                                  width: "13px",
                                  height: "13px",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  backgroundColor: "#ef4444",
                                  border: "none",
                                  padding: "0",
                                }}
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="8"
                                  height="8"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="white"
                                  strokeWidth="3"
                                  strokeLinecap="round"
                                  strokeLinejoin="round"
                                >
                                  <line x1="18" y1="6" x2="6" y2="18" />
                                  <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                              </button>
                              {/* Icon 6 cháº¥m náº±m ngang Ä‘á»ƒ di chuyá»ƒn */}
                              <div
                                draggable={isActive}
                                onDragStart={handleDragStart}
                                onDragEnd={handleDragEnd}
                                className="cursor-move flex-shrink-0 hover:bg-gray-200 rounded transition-colors"
                                title="Nháº¥n giá»¯ vÃ  kÃ©o Ä‘á»ƒ di chuyá»ƒn Ä‘Ã¡p Ã¡n"
                                style={{
                                  width: "18px",
                                  height: "14px",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  padding: "2px",
                                  userSelect: "none",
                                }}
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="18"
                                  height="10"
                                  viewBox="0 0 18 10"
                                  fill="currentColor"
                                  className="text-gray-600"
                                >
                                  <circle cx="2" cy="2" r="1.5" />
                                  <circle cx="9" cy="2" r="1.5" />
                                  <circle cx="16" cy="2" r="1.5" />
                                  <circle cx="2" cy="8" r="1.5" />
                                  <circle cx="9" cy="8" r="1.5" />
                                  <circle cx="16" cy="8" r="1.5" />
                                </svg>
                              </div>
                            </>
                          ) : (
                            /* Khi khÃ´ng active: hiá»ƒn thá»‹ checkbox hoáº·c radio tÃ¹y loáº¡i */
                            <input
                              type={isRadioType() ? "radio" : "checkbox"}
                              name={`question-${question.id}`}
                              value={option.id}
                              checked={isOptionChecked(
                                selectedAnswer,
                                option.id
                              )}
                              onChange={() =>
                                onAnswerSelect?.(
                                  question.id,
                                  option.id,
                                  question.type
                                )
                              }
                              onClick={(e) => e.stopPropagation()}
                              className="text-violet-600 focus:ring-violet-500 cursor-pointer flex-shrink-0 opacity-90"
                              style={{
                                accentColor: "#7c3aed",
                                width: "28px",
                                height: "28px",
                                borderRadius: isRadioType() ? "50%" : "4px",
                              }}
                            />
                          )}
                          <div
                            className="flex items-start space-x-2 ml-2"
                            style={{
                              width: isImageOptionType() ? "auto" : answerWidth,
                              flexShrink: 0,
                            }}
                          >
                            {isImageOptionType() ? (
                              /* Hiá»ƒn thá»‹ áº£nh cho loáº¡i "Chá»n hÃ¬nh áº£nh tá»« danh sÃ¡ch (Radio)" */
                              isActive ? (
                                /* Khi active: Hiá»ƒn thá»‹ áº£nh náº¿u cÃ³, hoáº·c Ã´ upload */
                                option.image ? (
                                  <div className="relative inline-block">
                                    <img
                                      src={option.image}
                                      alt="Option"
                                      className="peer border-2 border-gray-700 rounded-sm cursor-pointer"
                                      style={{
                                        height: "160px",
                                        width: "auto",
                                        objectFit: "contain",
                                        display: "block",
                                      }}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleOptionImageUpload(option.id);
                                      }}
                                    />
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        onOptionImageChange?.(
                                          question.id,
                                          option.id,
                                          null
                                        );
                                      }}
                                      className="absolute top-2 right-2 bg-red-500 hover:bg-red-600 rounded-full w-6 h-6 flex items-center justify-center transition-all opacity-0 peer-hover:opacity-100"
                                      title="XÃ³a áº£nh"
                                    >
                                      <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="24"
                                        height="24"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="white"
                                        strokeWidth="1.5"
                                        strokeLinecap="square"
                                        strokeLinejoin="miter"
                                      >
                                        <path d="M15.5355339 15.5355339L8.46446609 8.46446609M15.5355339 8.46446609L8.46446609 15.5355339" />
                                        <path d="M4.92893219,19.0710678 C1.02368927,15.1658249 1.02368927,8.83417511 4.92893219,4.92893219 C8.83417511,1.02368927 15.1658249,1.02368927 19.0710678,4.92893219 C22.9763107,8.83417511 22.9763107,15.1658249 19.0710678,19.0710678 C15.1658249,22.9763107 8.83417511,22.9763107 4.92893219,19.0710678 Z" />
                                      </svg>
                                    </button>
                                  </div>
                                ) : (
                                  <div
                                    className="border-2 border-dashed border-gray-700 rounded-md flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors"
                                    style={{
                                      width: "260px",
                                      height: "160px",
                                    }}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleOptionImageUpload(option.id);
                                    }}
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="32"
                                      height="32"
                                      viewBox="0 0 24 24"
                                      fill="none"
                                      stroke="currentColor"
                                      strokeWidth="2"
                                      className="text-gray-400 mb-2"
                                    >
                                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                      <polyline points="17 8 12 3 7 8" />
                                      <line x1="12" y1="3" x2="12" y2="15" />
                                    </svg>
                                    <span className="text-sm text-gray-500 italic">
                                      Tháº£ hÃ¬nh áº£nh táº¡i Ä‘Ã¢y
                                    </span>
                                  </div>
                                )
                              ) : /* Khi khÃ´ng active: Hiá»ƒn thá»‹ áº£nh hoáº·c NO IMAGE */
                              option.image ? (
                                <img
                                  src={option.image}
                                  alt="Option"
                                  className="border-2 border-gray-700 rounded-sm"
                                  style={{
                                    height: "160px",
                                    width: "auto",
                                    objectFit: "contain",
                                    display: "block",
                                  }}
                                />
                              ) : (
                                <div
                                  className="border-2 border-gray-700 rounded-md flex flex-col items-center justify-center bg-gray-50"
                                  style={{
                                    width: "160px",
                                    height: "160px",
                                  }}
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="48"
                                    height="48"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    strokeWidth="1.5"
                                    className="text-gray-300 mb-2"
                                  >
                                    <rect
                                      x="3"
                                      y="3"
                                      width="18"
                                      height="18"
                                      rx="2"
                                      ry="2"
                                    />
                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                    <polyline points="21 15 16 10 5 21" />
                                  </svg>
                                  <span className="text-gray-400 font-bold text-sm">
                                    NO IMAGE
                                  </span>
                                </div>
                              )
                            ) : /* Hiá»ƒn thá»‹ text bÃ¬nh thÆ°á»ng cho cÃ¡c loáº¡i khÃ¡c */
                            isActive ? (
                              <div
                                style={{
                                  width: answerWidth,
                                  flexShrink: 0,
                                }}
                              >
                                <EditableField
                                  placeholder={
                                    isRadioType()
                                      ? "Answer option"
                                      : "Subquestion"
                                  }
                                  initialValue={option.text}
                                  inputClassName="text-sm text-gray-700 placeholder:italic placeholder:text-gray-400 font-medium"
                                  isTextarea={true}
                                  onChange={(value) =>
                                    onOptionChange?.(
                                      question.id,
                                      option.id,
                                      value
                                    )
                                  }
                                />
                              </div>
                            ) : (
                              <div
                                style={{
                                  width: answerWidth,
                                  flexShrink: 0,
                                }}
                              >
                                <span
                                  className={`text-sm text-gray-700 font-medium ${
                                    !option.text ? "italic text-gray-400" : ""
                                  } inline-block whitespace-normal break-words leading-relaxed opacity-70`}
                                  style={{
                                    width: answerWidth,
                                    padding: "8px",
                                    marginLeft: "-8px",
                                    marginTop: "0",
                                    marginBottom: "0",
                                    boxSizing: "border-box",
                                    minHeight: "24px",
                                    lineHeight: "1.625",
                                    display: "inline-block",
                                    verticalAlign: "top",
                                  }}
                                >
                                  {option.text ||
                                    (isRadioType()
                                      ? "Answer option"
                                      : "Subquestion")}
                                </span>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )
              )}

              {/* Ã” nháº­n xÃ©t cho loáº¡i "Danh sÃ¡ch cÃ³ nháº­n xÃ©t (Radio)" - chá»‰ hiá»‡n khi khÃ´ng active */}
              {!isActive &&
                question.type === "Danh sÃ¡ch cÃ³ nháº­n xÃ©t (Radio)" && (
                  <div className="ml-[28px] mt-4">
                    <textarea
                      placeholder="Nháº­p nháº­n xÃ©t cá»§a báº¡n táº¡i Ä‘Ã¢y."
                      className="w-full border-2 border-gray-700 rounded-md p-3 text-sm text-gray-700 placeholder:italic placeholder:text-gray-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 resize-none"
                      rows="3"
                      style={{ width: answerWidth }}
                    />
                  </div>
                )}

              {/* Actions: thu theo ná»™i dung (khÃ´ng absolute) */}
              {isActive && (
                <div className="mt-6 flex items-start justify-between">
                  {!isGenderType() && !isYesNoType() && !isDateTimeType() && !isFileUploadType() && !isShortTextType() && !isMultipleShortTextType() && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onAddOption?.(question.id);
                      }}
                      className="flex items-center text-violet-600 text-sm hover:text-violet-800 transition-colors font-normal ml-[28px]"
                    >
                      <PlusIcon className="h-5 w-5 mr-1" />
                      ThÃªm cÃ¢u há»i phá»¥
                    </button>
                  )}

                  <div
                    className={`flex items-center space-x-1 ${
                      isGenderType() || isYesNoType() || isDateTimeType() || isFileUploadType() || isShortTextType() || isMultipleShortTextType()
                        ? "ml-auto"
                        : "mt-[45px]"
                    }`}
                  >
                    <button
                      className="p-1"
                      title="Duplicate"
                      onClick={(e) => {
                        e.stopPropagation();
                        onDuplicate?.(index);
                      }}
                    >
                      <DuplicateIcon />
                    </button>
                    <button
                      className="p-1"
                      title="Delete"
                      onClick={(e) => {
                        e.stopPropagation();
                        onDelete?.(index);
                      }}
                    >
                      <TrashIcon />
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        ) : (
          /* ======================= Bá» Cá»¤C Máº¶C Äá»ŠNH (KHÃ”NG áº¢NH) ======================= */
          <div className="p-6 pb-[35px]">
            <div className="flex items-baseline">
              <span className="text-violet-600 font-medium mr-2 whitespace-nowrap">
                {index + 1} â†’
              </span>
              <div className="w-full">
                <EditableField
                  placeholder="Nháº­p cÃ¢u há»i cá»§a báº¡n á»Ÿ Ä‘Ã¢y"
                  initialValue={question.text}
                  inputClassName="text-gray-900 font-thin text-[25px]"
                  onChange={(value) => onTextChange?.(question.id, value)}
                />
                <EditableField
                  placeholder="MÃ´ táº£ trá»£ giÃºp tuá»³ chá»n"
                  initialValue={question.helpText}
                  inputClassName="text-sm text-gray-800 mt-1 mb-4 italic font-medium"
                />
              </div>
            </div>

            {/* Render 5 Ä‘iá»ƒm náº¿u lÃ  loáº¡i Lá»±a chá»n 5 Ä‘iá»ƒm */}
            {isFivePointScale() ? (
              <FivePointScale
                questionId={question.id}
                selectedAnswer={selectedAnswer}
                onAnswerSelect={onAnswerSelect}
                isActive={isActive}
                hasImage={false}
              />
            ) : isGenderType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i Giá»›i tÃ­nh */
              <div className="ml-[28px] flex gap-4 flex-wrap">
                {options.map((option) => {
                  const isSelected = isOptionChecked(selectedAnswer, option.id);
                  const isNoAnswer = option.text === "KhÃ´ng cÃ³ cÃ¢u tráº£ lá»i";

                  return (
                    <button
                      key={option.id}
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onAnswerSelect?.(question.id, option.id, question.type);
                      }}
                      className="gender-button relative group"
                      style={{
                        width: isNoAnswer ? "173px" : "90px",
                        height: "75px",
                      }}
                    >
                      <div
                        className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-all
                        ${
                          isSelected
                            ? "bg-[#10B981] border-[#10B981] text-white"
                            : isNoAnswer
                            ? "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                            : "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                        }
                      `}
                      >
                        {option.text === "Ná»¯" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M11 15.934A7.501 7.501 0 0 1 12 1a7.5 7.5 0 0 1 1 14.934V18h5v2h-5v4h-2v-4H6v-2h5v-2.066zM12 14a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                          </svg>
                        )}
                        {option.text === "Nam" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M15.05 8.537L18.585 5H14V3h8v8h-2V6.414l-3.537 3.537a7.5 7.5 0 1 1-1.414-1.414zM10.5 20a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                          </svg>
                        )}
                        {isNoAnswer && (
                          <svg
                            role="img"
                            xmlns="http://www.w3.org/2000/svg"
                            width="32px"
                            height="32px"
                            viewBox="0 0 24 24"
                            aria-labelledby="circleIconTitle"
                            stroke={isSelected ? "#ffffff" : "#000000"}
                            strokeWidth="1.5"
                            strokeLinecap="square"
                            strokeLinejoin="miter"
                            fill="none"
                            color={isSelected ? "#ffffff" : "#000000"}
                            className="mb-1 transition-colors"
                          >
                            <title id="circleIconTitle">Circle</title>
                            <circle cx="12" cy="12" r="8" />
                          </svg>
                        )}
                        <span
                          className="text-sm font-medium transition-colors"
                          style={{
                            color: isSelected ? "#ffffff" : "#4b5563",
                            width: isNoAnswer ? "145px" : "auto",
                            height: isNoAnswer ? "24px" : "auto",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            textAlign: "center",
                          }}
                        >
                          {option.text}
                        </span>
                      </div>
                      {/* Overlay khi hover Ä‘á»ƒ Ä‘á»•i mÃ u icon vÃ  chá»¯ */}
                      <div
                        className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-opacity pointer-events-none
                        bg-[#10B981] border-[#10B981] text-white
                        ${
                          isSelected
                            ? "opacity-100"
                            : "opacity-0 group-hover:opacity-100"
                        }
                      `}
                      >
                        {option.text === "Ná»¯" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M11 15.934A7.501 7.501 0 0 1 12 1a7.5 7.5 0 0 1 1 14.934V18h5v2h-5v4h-2v-4H6v-2h5v-2.066zM12 14a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                          </svg>
                        )}
                        {option.text === "Nam" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M15.05 8.537L18.585 5H14V3h8v8h-2V6.414l-3.537 3.537a7.5 7.5 0 1 1-1.414-1.414zM10.5 20a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11z"></path>
                          </svg>
                        )}
                        {isNoAnswer && (
                          <div
                            className="mb-1 rounded-full flex items-center justify-center"
                            style={{
                              width: "32px",
                              height: "32px",
                              border: "2px solid #ffffff",
                            }}
                          >
                            <div
                              className="rounded-full"
                              style={{
                                width: "20px",
                                height: "20px",
                                border: "2px solid #ffffff",
                              }}
                            ></div>
                          </div>
                        )}
                        <span className="text-sm font-medium text-white">
                          {option.text}
                        </span>
                      </div>
                    </button>
                  );
                })}
              </div>
            ) : isYesNoType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i CÃ³/KhÃ´ng */
              <div className="ml-[28px] flex gap-4 flex-wrap">
                {options.map((option) => {
                  const isSelected = isOptionChecked(selectedAnswer, option.id);
                  const isNoAnswer = option.text === "KhÃ´ng cÃ³ cÃ¢u tráº£ lá»i";

                  return (
                    <button
                      key={option.id}
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onAnswerSelect?.(question.id, option.id, question.type);
                      }}
                      className="gender-button relative group"
                      style={{
                        width: isNoAnswer ? "173px" : "90px",
                        height: "75px",
                      }}
                    >
                      <div
                        className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-all
                        ${
                          isSelected
                            ? "bg-[#10B981] border-[#10B981] text-white"
                            : isNoAnswer
                            ? "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                            : "bg-white border-gray-600 group-hover:bg-[#10B981] group-hover:border-[#10B981]"
                        }
                      `}
                      >
                        {option.text === "CÃ³" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"></path>
                          </svg>
                        )}
                        {option.text === "KhÃ´ng" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"></path>
                          </svg>
                        )}
                        {isNoAnswer && (
                          <svg
                            role="img"
                            xmlns="http://www.w3.org/2000/svg"
                            width="32px"
                            height="32px"
                            viewBox="0 0 24 24"
                            aria-labelledby="circleIconTitle"
                            stroke={isSelected ? "#ffffff" : "#4b5563"}
                            strokeWidth="1.5"
                            strokeLinecap="square"
                            strokeLinejoin="miter"
                            fill="none"
                            color={isSelected ? "#ffffff" : "#4b5563"}
                            className="mb-1 transition-colors"
                          >
                            <title id="circleIconTitle">Circle</title>
                            <circle cx="12" cy="12" r="8" />
                          </svg>
                        )}
                        <span
                          className="text-sm font-medium transition-colors"
                          style={{
                            color: isSelected ? "#ffffff" : "#4b5563",
                            width: isNoAnswer ? "145px" : "auto",
                            height: isNoAnswer ? "24px" : "auto",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            textAlign: "center",
                          }}
                        >
                          {option.text}
                        </span>
                      </div>
                      {/* Overlay khi hover Ä‘á»ƒ Ä‘á»•i mÃ u icon vÃ  chá»¯ */}
                      <div
                        className={`
                        absolute inset-0 flex flex-col items-center justify-center
                        border-[3px] rounded-md transition-opacity pointer-events-none
                        bg-[#10B981] border-[#10B981] text-white
                        ${
                          isSelected
                            ? "opacity-100"
                            : "opacity-0 group-hover:opacity-100"
                        }
                      `}
                      >
                        {option.text === "CÃ³" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm-.997-4L6.76 11.757l1.414-1.414 2.829 2.829 5.656-5.657 1.415 1.414L11.003 16z"></path>
                          </svg>
                        )}
                        {option.text === "KhÃ´ng" && (
                          <svg
                            width="32"
                            height="32"
                            fill="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"></path>
                          </svg>
                        )}
                        {isNoAnswer && (
                          <svg
                            role="img"
                            xmlns="http://www.w3.org/2000/svg"
                            width="32px"
                            height="32px"
                            viewBox="0 0 24 24"
                            aria-labelledby="circleIconTitle"
                            stroke="#ffffff"
                            strokeWidth="1.5"
                            strokeLinecap="square"
                            strokeLinejoin="miter"
                            fill="none"
                            color="#ffffff"
                            className="mb-1"
                          >
                            <title id="circleIconTitle">Circle</title>
                            <circle cx="12" cy="12" r="8" />
                          </svg>
                        )}
                        <span className="text-sm font-medium text-white">
                          {option.text}
                        </span>
                      </div>
                    </button>
                  );
                })}
              </div>
            ) : isDateTimeType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i NgÃ y giá» */
              <div className="ml-[28px]">
                <div
                  className="relative"
                  style={{ width: "326px", height: "43px" }}
                >
                  {/* Input áº©n cho date picker */}
                  <input
                    ref={datePickerRef}
                    type="date"
                    style={{
                      position: "absolute",
                      opacity: 0,
                      pointerEvents: "none",
                      width: 0,
                      height: 0,
                      overflow: "hidden",
                    }}
                    onChange={handleDatePickerChange}
                    onClick={(e) => e.stopPropagation()}
                  />
                  <input
                    type="text"
                    className="border-[3px] border-gray-400 rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none uppercase"
                    style={{
                      width: "326px",
                      height: "43px",
                      paddingRight: "40px",
                      fontSize: "14px",
                      letterSpacing: "0.5px",
                    }}
                    placeholder="MM/DD/YYYY"
                    value={dateInputValue}
                    onChange={handleDateInputChange}
                    onClick={(e) => e.stopPropagation()}
                    maxLength={10}
                  />
                  <button
                    type="button"
                    aria-label="Open date picker"
                    className="absolute right-2 top-1/2 -translate-y-1/2 rounded hover:bg-gray-100 transition-colors pointer-events-auto"
                    onClick={openDatePicker}
                    style={{
                      width: "24px",
                      height: "24px",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                    }}
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      className="text-gray-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      strokeWidth={2}
                      style={{ width: "24px", height: "24px" }}
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                      />
                    </svg>
                  </button>
                </div>
              </div>
            ) : isFileUploadType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i Táº£i lÃªn tá»‡p */
              <div className="ml-[28px]">
                <div
                  className={`border-2 border-dashed rounded-md transition-colors cursor-pointer ${
                    isFileDragging
                      ? "border-violet-500 bg-violet-50"
                      : "border-gray-400 bg-gray-50 hover:bg-gray-100"
                  }`}
                  style={{
                    width: "100%",
                    minHeight: "200px",
                    padding: "40px",
                    display: "flex",
                    flexDirection: "column",
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                  onClick={handleFileUploadClick}
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={handleDrop}
                >
                  {uploadedFiles.length > 0 ? (
                    <div className="flex flex-col items-center space-y-3 w-full">
                      {uploadedFiles.map((file) => (
                        <div
                          key={file.id}
                          className="flex items-center space-x-3 bg-white rounded-md p-4 border-2 border-gray-300 w-full max-w-md"
                          onClick={(e) => e.stopPropagation()}
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            strokeWidth="2"
                            className="text-gray-600"
                          >
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                          </svg>
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium text-gray-800 truncate">
                              {file.name}
                            </p>
                            <p className="text-xs text-gray-500">
                              {(file.size / 1024).toFixed(2)} KB
                            </p>
                          </div>
                          {(isActive || !isActive) && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleRemoveFile(file.id);
                              }}
                              className="text-red-500 hover:text-red-700 transition-colors"
                              title="XÃ³a file"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                strokeWidth="2"
                              >
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                              </svg>
                            </button>
                          )}
                        </div>
                      ))}
                      {!isActive && uploadedFiles.length < (question?.maxQuestions || 1) && (
                        <button
                          onClick={handleFileUploadClick}
                          className="text-sm text-violet-600 hover:text-violet-800 font-medium"
                        >
                          ThÃªm tá»‡p khÃ¡c
                        </button>
                      )}
                      {uploadedFiles.length >= (question?.maxQuestions || 1) && (
                        <p className="text-xs text-gray-500 italic">
                          ÄÃ£ Ä‘áº¡t giá»›i háº¡n ({question?.maxQuestions || 1} tá»‡p)
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="flex flex-col items-center space-y-3">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="2"
                        className="text-gray-400"
                      >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                      </svg>
                      <p className="text-sm text-gray-600 font-medium">
                        Chá»n tá»‡p hoáº·c kÃ©o hÃ¬nh áº£nh vÃ o Ä‘Ã¢y
                      </p>
                    </div>
                  )}
                  {fileUploadError && (
                    <div className="mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-md p-2 w-full max-w-md">
                      {fileUploadError}
                    </div>
                  )}
                </div>
              </div>
            ) : isShortTextType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i VÄƒn báº£n ngáº¯n */
              <div className="ml-[28px]">
                <input
                  type="text"
                  className={`border-[3px] rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none ${
                    textInputError
                      ? "border-red-500"
                      : "border-gray-400 focus:border-violet-500"
                  }`}
                  style={{
                    width: "651px",
                    height: "36px",
                    fontSize: "14px",
                  }}
                  placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                  value={textInputValue}
                  onChange={handleTextInputChange}
                  onClick={(e) => e.stopPropagation()}
                  maxLength={question?.maxLength || 500}
                />
                {textInputError && (
                  <div className="mt-2 text-sm text-red-600">
                    {textInputError}
                  </div>
                )}
              </div>
            ) : isLongTextType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i VÄƒn báº£n dÃ i */
              <div className="ml-[28px]">
                <textarea
                  className={`border-[3px] rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none ${
                    textInputError
                      ? "border-red-500"
                      : "border-gray-400 focus:border-violet-500"
                  }`}
                  style={{
                    width: "651px",
                    minHeight: "100px",
                    fontSize: "14px",
                    resize: "vertical",
                  }}
                  placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                  value={textInputValue}
                  onChange={handleTextInputChange}
                  onClick={(e) => e.stopPropagation()}
                  maxLength={question?.maxLength || 2500}
                />
                {textInputError && (
                  <div className="mt-2 text-sm text-red-600">
                    {textInputError}
                  </div>
                )}
              </div>
            ) : isMultipleShortTextType() ? (
              /* UI Ä‘áº·c biá»‡t cho loáº¡i Nhiá»u vÄƒn báº£n ngáº¯n */
              options.length > 0 && (
                <div className="ml-[28px] space-y-4">
                  {options.map((option, optionIndex) => {
                    const isDragging = draggedIndex === optionIndex;
                    const isDragOver = dragOverIndex === optionIndex;

                    const handleDragStart = (e) => {
                      setDraggedIndex(optionIndex);
                      e.dataTransfer.effectAllowed = "move";
                      e.dataTransfer.setData(
                        "text/plain",
                        optionIndex.toString()
                      );
                    };

                    const handleDragOver = (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      e.dataTransfer.dropEffect = "move";
                      if (dragOverIndex !== optionIndex) {
                        setDragOverIndex(optionIndex);
                      }
                    };

                    const handleDragLeave = (e) => {
                      e.preventDefault();
                      const rect = e.currentTarget.getBoundingClientRect();
                      const x = e.clientX;
                      const y = e.clientY;
                      if (
                        x < rect.left ||
                        x > rect.right ||
                        y < rect.top ||
                        y > rect.bottom
                      ) {
                        setDragOverIndex(null);
                      }
                    };

                    const handleDrop = (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      if (
                        draggedIndex !== null &&
                        draggedIndex !== optionIndex &&
                        onMoveOption
                      ) {
                        onMoveOption(question.id, draggedIndex, optionIndex);
                      }
                      setDraggedIndex(null);
                      setDragOverIndex(null);
                    };

                    const handleDragEnd = () => {
                      setDraggedIndex(null);
                      setDragOverIndex(null);
                    };

                    return (
                      <div
                        key={option.id}
                        className={isActive ? "flex items-center group" : "flex flex-col group"}
                        style={{
                          gap: "8px",
                          minHeight: "40px",
                          opacity: isDragging ? 1 : 1,
                          transition: "all 0.2s",
                          backgroundColor: isDragging
                            ? "#ffffff"
                            : isDragOver
                            ? "#f3f4f6"
                            : "transparent",
                          border: isDragging
                            ? "2px solid #7c3aed"
                            : "2px solid transparent",
                          borderRadius: isDragging ? "6px" : "0px",
                          padding: isDragging ? "4px" : "0px",
                        }}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                      >
                        {/* Khi active: hiá»ƒn thá»‹ icon X vÃ  icon grid */}
                        {isActive ? (
                          <>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                onRemoveOption?.(question.id, option.id);
                              }}
                              className="flex-shrink-0 hover:bg-red-100 rounded-full transition-colors"
                              title="XÃ³a Ä‘Ã¡p Ã¡n"
                              style={{
                                width: "13px",
                                height: "13px",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                backgroundColor: "#ef4444",
                                border: "none",
                                padding: "0",
                              }}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="8"
                                height="8"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="white"
                                strokeWidth="3"
                                strokeLinecap="round"
                                strokeLinejoin="round"
                              >
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                              </svg>
                            </button>
                            <div
                              draggable={isActive}
                              onDragStart={handleDragStart}
                              onDragEnd={handleDragEnd}
                              className="cursor-move flex-shrink-0 hover:bg-gray-200 rounded transition-colors"
                              title="Nháº¥n giá»¯ vÃ  kÃ©o Ä‘á»ƒ di chuyá»ƒn Ä‘Ã¡p Ã¡n"
                              style={{
                                width: "18px",
                                height: "14px",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                padding: "2px",
                                userSelect: "none",
                              }}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="18"
                                height="10"
                                viewBox="0 0 18 10"
                                fill="currentColor"
                                className="text-gray-600"
                              >
                                <circle cx="2" cy="2" r="1.5" />
                                <circle cx="9" cy="2" r="1.5" />
                                <circle cx="16" cy="2" r="1.5" />
                                <circle cx="2" cy="8" r="1.5" />
                                <circle cx="9" cy="8" r="1.5" />
                                <circle cx="16" cy="8" r="1.5" />
                              </svg>
                            </div>
                          </>
                        ) : null}
                        {/* Text cá»§a subquestion */}
                        <div className="flex items-center" style={{ width: "290px", wordWrap: "break-word" }}>
                          <EditableField
                            placeholder="Subquestion"
                            initialValue={option.text}
                            inputClassName="text-gray-800 font-medium"
                            isTextarea={true}
                            onChange={(value) =>
                              onOptionChange?.(question.id, option.id, value)
                            }
                          />
                        </div>
                        {/* Input text bÃªn cáº¡nh (khi khÃ´ng active) */}
                        {!isActive && (
                          <input
                            type="text"
                            className="border-[3px] border-gray-400 rounded-md px-3 py-2 font-semibold text-gray-800 focus:outline-none focus:border-violet-500"
                            style={{
                              width: imageValue ? "174px" : "300px",
                              height: "40px",
                              fontSize: "14px",
                            }}
                            placeholder="Nháº­p cÃ¢u tráº£ lá»i cá»§a báº¡n táº¡i Ä‘Ã¢y."
                            value={multipleTextInputs[option.id] || ""}
                            onChange={(e) => {
                              e.stopPropagation();
                              handleMultipleTextInputChange(option.id, e.target.value);
                            }}
                            onClick={(e) => e.stopPropagation()}
                            maxLength={256}
                          />
                        )}
                      </div>
                    );
                  })}
                </div>
              )
            ) : (
              /* Danh sÃ¡ch Ä‘Ã¡p Ã¡n */
              options.length > 0 && (
                <div className="ml-[28px] space-y-4">
                  {options.map((option, optionIndex) => {
                    const isDragging = draggedIndex === optionIndex;
                    const isDragOver = dragOverIndex === optionIndex;

                    const handleDragStart = (e) => {
                      setDraggedIndex(optionIndex);
                      e.dataTransfer.effectAllowed = "move";
                      e.dataTransfer.setData(
                        "text/plain",
                        optionIndex.toString()
                      );

                      // Táº¡o custom drag image tá»« cáº£ dÃ²ng Ä‘Ã¡p Ã¡n
                      const rowElement = e.currentTarget.closest(
                        ".flex.items-center.group"
                      );
                      if (rowElement) {
                        const dragImage = rowElement.cloneNode(true);
                        dragImage.style.position = "absolute";
                        dragImage.style.top = "-9999px";
                        dragImage.style.left = "-9999px";
                        dragImage.style.width = rowElement.offsetWidth + "px";
                        dragImage.style.backgroundColor = "#ffffff";
                        dragImage.style.border = "3px solid #7c3aed";
                        dragImage.style.borderRadius = "8px";
                        dragImage.style.padding = "10px";
                        dragImage.style.boxShadow =
                          "0 8px 24px rgba(124, 58, 237, 0.3), 0 4px 8px rgba(0,0,0,0.1)";
                        dragImage.style.transform = "scale(1.02)";
                        dragImage.style.fontWeight = "600";
                        document.body.appendChild(dragImage);
                        e.dataTransfer.setDragImage(dragImage, 30, 20);
                        setTimeout(
                          () => document.body.removeChild(dragImage),
                          0
                        );
                      }
                    };

                    const handleDragOver = (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      e.dataTransfer.dropEffect = "move";
                      if (dragOverIndex !== optionIndex) {
                        setDragOverIndex(optionIndex);
                      }
                    };

                    const handleDragLeave = (e) => {
                      e.preventDefault();
                      const rect = e.currentTarget.getBoundingClientRect();
                      const x = e.clientX;
                      const y = e.clientY;
                      if (
                        x < rect.left ||
                        x > rect.right ||
                        y < rect.top ||
                        y > rect.bottom
                      ) {
                        setDragOverIndex(null);
                      }
                    };

                    const handleDrop = (e) => {
                      e.preventDefault();
                      e.stopPropagation();

                      if (
                        draggedIndex !== null &&
                        draggedIndex !== optionIndex &&
                        onMoveOption
                      ) {
                        onMoveOption(question.id, draggedIndex, optionIndex);
                      }

                      setDraggedIndex(null);
                      setDragOverIndex(null);
                    };

                    const handleDragEnd = () => {
                      setDraggedIndex(null);
                      setDragOverIndex(null);
                    };

                    return (
                      <div
                        key={option.id}
                        className={
                          isImageOptionType()
                            ? "flex items-start group"
                            : "inline-flex items-center group"
                        }
                        style={{
                          gap: "8px",
                          minHeight: "40px",
                          opacity: isDragging ? 1 : 1,
                          transition: "all 0.2s",
                          backgroundColor: isDragging
                            ? "#ffffff"
                            : isDragOver
                            ? "#f3f4f6"
                            : "transparent",
                          border: isDragging
                            ? "2px solid #7c3aed"
                            : "2px solid transparent",
                          borderRadius: isDragging ? "6px" : "0px",
                          padding: isDragging ? "4px" : "0px",
                        }}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                      >
                        {/* Khi active: hiá»ƒn thá»‹ icon X (hÃ¬nh trÃ²n 13x13) vÃ  icon grid (14x14) */}
                        {isActive ? (
                          <>
                            {/* Icon X Ä‘á»ƒ xÃ³a - hÃ¬nh trÃ²n 13x13 */}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                onRemoveOption?.(question.id, option.id);
                              }}
                              className="flex-shrink-0 hover:bg-red-100 rounded-full transition-colors"
                              title="XÃ³a Ä‘Ã¡p Ã¡n"
                              style={{
                                width: "13px",
                                height: "13px",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                backgroundColor: "#ef4444",
                                border: "none",
                                padding: "0",
                              }}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="8"
                                height="8"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="white"
                                strokeWidth="3"
                                strokeLinecap="round"
                                strokeLinejoin="round"
                              >
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                              </svg>
                            </button>
                            {/* Icon 6 cháº¥m náº±m ngang Ä‘á»ƒ di chuyá»ƒn */}
                            <div
                              draggable={isActive}
                              onDragStart={handleDragStart}
                              onDragEnd={handleDragEnd}
                              className="cursor-move flex-shrink-0 hover:bg-gray-200 rounded transition-colors"
                              title="Nháº¥n giá»¯ vÃ  kÃ©o Ä‘á»ƒ di chuyá»ƒn Ä‘Ã¡p Ã¡n"
                              style={{
                                width: "18px",
                                height: "14px",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                padding: "2px",
                                userSelect: "none",
                              }}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="18"
                                height="10"
                                viewBox="0 0 18 10"
                                fill="currentColor"
                                className="text-gray-600"
                              >
                                <circle cx="2" cy="2" r="1.5" />
                                <circle cx="9" cy="2" r="1.5" />
                                <circle cx="16" cy="2" r="1.5" />
                                <circle cx="2" cy="8" r="1.5" />
                                <circle cx="9" cy="8" r="1.5" />
                                <circle cx="16" cy="8" r="1.5" />
                              </svg>
                            </div>
                          </>
                        ) : (
                          /* Khi khÃ´ng active: hiá»ƒn thá»‹ checkbox hoáº·c radio tÃ¹y loáº¡i */
                          <input
                            type={isRadioType() ? "radio" : "checkbox"}
                            name={`question-${question.id}`}
                            value={option.id}
                            checked={isOptionChecked(selectedAnswer, option.id)}
                            onChange={() =>
                              onAnswerSelect?.(
                                question.id,
                                option.id,
                                question.type
                              )
                            }
                            onClick={(e) => e.stopPropagation()}
                            className="text-violet-600 focus:ring-violet-500 cursor-pointer flex-shrink-0 opacity-90"
                            style={{
                              accentColor: "#7c3aed",
                              width: "28px",
                              height: "28px",
                              borderRadius: isRadioType() ? "50%" : "4px",
                            }}
                          />
                        )}
                        <div
                          className="flex items-start space-x-2 ml-4"
                          style={{
                            width: isImageOptionType() ? "auto" : "300px",
                            flexShrink: 0,
                          }}
                        >
                          {isImageOptionType() ? (
                            /* Hiá»ƒn thá»‹ áº£nh cho loáº¡i "Chá»n hÃ¬nh áº£nh tá»« danh sÃ¡ch (Radio)" */
                            isActive ? (
                              /* Khi active: Hiá»ƒn thá»‹ áº£nh náº¿u cÃ³, hoáº·c Ã´ upload */
                              option.image ? (
                                <div className="relative inline-block">
                                  <img
                                    src={option.image}
                                    alt="Option"
                                    className="peer border-1 border-gray-900 rounded-sm cursor-pointer"
                                    style={{
                                      height: "160px",
                                      width: "auto",
                                      objectFit: "contain",
                                      display: "block",
                                    }}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleOptionImageUpload(option.id);
                                    }}
                                  />
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onOptionImageChange?.(
                                        question.id,
                                        option.id,
                                        null
                                      );
                                    }}
                                    className="absolute top-2 right-2 bg-red-500 hover:bg-red-600 rounded-full w-6 h-6 flex items-center justify-center transition-all opacity-0 peer-hover:opacity-100"
                                    title="XÃ³a áº£nh"
                                  >
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      width="24"
                                      height="24"
                                      viewBox="0 0 24 24"
                                      fill="none"
                                      stroke="white"
                                      strokeWidth="1.5"
                                      strokeLinecap="square"
                                      strokeLinejoin="miter"
                                    >
                                      <path d="M15.5355339 15.5355339L8.46446609 8.46446609M15.5355339 8.46446609L8.46446609 15.5355339" />
                                      <path d="M4.92893219,19.0710678 C1.02368927,15.1658249 1.02368927,8.83417511 4.92893219,4.92893219 C8.83417511,1.02368927 15.1658249,1.02368927 19.0710678,4.92893219 C22.9763107,8.83417511 22.9763107,15.1658249 19.0710678,19.0710678 C15.1658249,22.9763107 8.83417511,22.9763107 4.92893219,19.0710678 Z" />
                                    </svg>
                                  </button>
                                </div>
                              ) : (
                                <div
                                  className="border-2 border-dashed border-gray-700 rounded-md flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors"
                                  style={{
                                    width: "260px",
                                    height: "160px",
                                  }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleOptionImageUpload(option.id);
                                  }}
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="32"
                                    height="32"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    strokeWidth="2"
                                    className="text-gray-400 mb-2"
                                  >
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                  </svg>
                                  <span className="text-sm text-gray-500 italic">
                                    Tháº£ hÃ¬nh áº£nh táº¡i Ä‘Ã¢y
                                  </span>
                                </div>
                              )
                            ) : /* Khi khÃ´ng active: Hiá»ƒn thá»‹ áº£nh hoáº·c NO IMAGE */
                            option.image ? (
                              <img
                                src={option.image}
                                alt="Option"
                                className="border-2 border-gray-700 rounded-sm"
                                style={{
                                  height: "160px",
                                  width: "auto",
                                  objectFit: "contain",
                                  display: "block",
                                }}
                              />
                            ) : (
                              <div
                                className="border-2 border-gray-700 rounded-md flex flex-col items-center justify-center bg-gray-50"
                                style={{
                                  width: "160px",
                                  height: "160px",
                                }}
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="48"
                                  height="48"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                  strokeWidth="1.5"
                                  className="text-gray-300 mb-2"
                                >
                                  <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                  />
                                  <circle cx="8.5" cy="8.5" r="1.5" />
                                  <polyline points="21 15 16 10 5 21" />
                                </svg>
                                <span className="text-gray-400 font-bold text-sm">
                                  NO IMAGE
                                </span>
                              </div>
                            )
                          ) : /* Hiá»ƒn thá»‹ text bÃ¬nh thÆ°á»ng cho cÃ¡c loáº¡i khÃ¡c */
                          isActive ? (
                            <div
                              style={{
                                width: "300px",
                                flexShrink: 0,
                              }}
                            >
                              <EditableField
                                placeholder={
                                  isRadioType()
                                    ? "Answer option"
                                    : "Subquestion"
                                }
                                initialValue={option.text}
                                inputClassName="text-sm text-gray-700 placeholder:italic placeholder:text-gray-400 font-medium"
                                isTextarea={true}
                                onChange={(value) =>
                                  onOptionChange?.(
                                    question.id,
                                    option.id,
                                    value
                                  )
                                }
                              />
                            </div>
                          ) : (
                            <div
                              style={{
                                width: "300px",
                                flexShrink: 0,
                              }}
                            >
                              <span
                                className={`text-sm text-gray-700 font-medium ${
                                  !option.text ? "italic text-gray-400" : ""
                                } inline-block whitespace-normal break-words leading-relaxed opacity-70`}
                                style={{
                                  width: "300px",
                                  padding: "8px",
                                  marginLeft: "-8px",
                                  marginTop: "0",
                                  marginBottom: "0",
                                  boxSizing: "border-box",
                                  minHeight: "24px",
                                  lineHeight: "1.625",
                                  display: "inline-block",
                                  verticalAlign: "top",
                                }}
                              >
                                {option.text ||
                                  (isRadioType()
                                    ? "Answer option"
                                    : "Subquestion")}
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )
            )}

            {/* Ã” nháº­n xÃ©t cho loáº¡i "Danh sÃ¡ch cÃ³ nháº­n xÃ©t (Radio)" - chá»‰ hiá»‡n khi khÃ´ng active */}
            {!isActive && question.type === "Danh sÃ¡ch cÃ³ nháº­n xÃ©t (Radio)" && (
              <div className="ml-[28px] mt-4">
                <textarea
                  placeholder="Nháº­p nháº­n xÃ©t cá»§a báº¡n táº¡i Ä‘Ã¢y."
                  className="w-full border-2 border-gray-700 rounded-md p-3 text-sm text-gray-700 placeholder:italic placeholder:text-gray-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 resize-none"
                  rows="3"
                  style={{ width: "300px" }}
                />
              </div>
            )}

            {/* Actions: Ä‘áº·t inline bÃªn dÆ°á»›i ná»™i dung */}
            {isActive && (
              <div className="mt-6 flex items-start justify-between">
                {!isGenderType() && !isYesNoType() && !isDateTimeType() && !isFileUploadType() && (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      onAddOption?.(question.id);
                    }}
                    className="flex items-center text-violet-600 text-sm hover:text-violet-800 transition-colors font-normal ml-[28px]"
                  >
                    <PlusIcon className="h-5 w-5 mr-1" />
                    ThÃªm cÃ¢u há»i phá»¥
                  </button>
                )}

                <div
                  className={`flex items-center space-x-1 ${
                    isGenderType() || isYesNoType() || isDateTimeType() || isFileUploadType()
                      ? "ml-auto"
                      : "mt-[70px]"
                  }`}
                >
                  <button
                    className="p-1"
                    title="Duplicate"
                    onClick={(e) => {
                      e.stopPropagation();
                      onDuplicate?.(index);
                    }}
                  >
                    <DuplicateIcon />
                  </button>
                  <button
                    className="p-1"
                    title="Delete"
                    onClick={(e) => {
                      e.stopPropagation();
                      onDelete?.(index);
                    }}
                  >
                    <TrashIcon />
                  </button>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

